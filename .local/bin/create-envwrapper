#!/bin/bash

if [[ $# -lt 2 ]]; then
    echo "usage: create-envwrapper <appname> <ENV1=VAL1 ENV2=VAL2 ...>"
    exit 1
fi

appname="$1"
shift
envs="$@"

envdir="$HOME/.local/share/envwrapper"
desktopdir="$HOME/.local/share/applications"
wrapper="$HOME/.local/bin/envwrapper"

mkdir -p "$envdir" "$desktopdir"

# 1. create env file
echo "[+] Writing env file for $appname..."
echo "$envs" | tr ' ' '\n' > "$envdir/${appname}.env"

# 2. find and copy .desktop
srcdesktop=$(find /usr/share/applications ~/.local/share/applications -name "${appname}.desktop" | head -n1)

if [[ -z "$srcdesktop" ]]; then
    echo "❌ No .desktop file found for $appname."
    exit 1
fi

cp "$srcdesktop" "$desktopdir/"

# 3. patch Exec line with absolute path to envwrapper
sed -i "s|^Exec=.*|Exec=$HOME/.local/bin/envwrapper $appname|" "$desktopdir/${appname}.desktop"

# 4. remove duplicate or broken Path= lines
sed -i '/^Path=.*$/d' "$desktopdir/${appname}.desktop"

# 5. optional: clean trailing whitespace (ocd mode lol)
sed -i 's/[ \t]*$//' "$desktopdir/${appname}.desktop"

echo "[✓] Patched .desktop file: $desktopdir/${appname}.desktop"
echo "[✓] Env file written: $envdir/${appname}.env"
echo "[✓] Now launch '$appname' through rofi/menu as normal!"
