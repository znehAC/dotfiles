#!/usr/bin/env bash
set -euo pipefail
trap 'echo "[ðŸ’¥] abort @ ${BASH_SOURCE[0]}:$LINENO"; exit 1' ERR

SETUP="$HOME/.setup"
log(){ printf '[%s] %s\n' "$(date '+%F %T')" "$*"; }

log "ðŸ”§ restoringâ€¦"

##############################################################################
# wallpapers
##############################################################################
for ext in jpg png; do
  src="$SETUP/wallpapers/wallpaper.$ext"
  [[ -f $src ]] && { mkdir -p "$HOME/Pictures"; cp "$src" "$HOME/Pictures/"; break; }
done

##############################################################################
# fonts
##############################################################################
if [[ -d $SETUP/fonts ]]; then
  rsync -aHAXx --chmod=u+rwX --delete "$SETUP/fonts/" "$HOME/.local/share/fonts/"
  fc-cache -fv
fi

##############################################################################
# zen browser desktop + user.js
##############################################################################
if [[ -f $SETUP/zen/zen.desktop ]]; then
  mkdir -p "$HOME/.local/share/applications"
  cp "$SETUP/zen/zen.desktop" "$HOME/.local/share/applications/"
fi

prof=$(find "$HOME/.mozilla" -maxdepth 2 -type d -name '*.zen*' | head -n1 || true)
[[ -n $prof && -f $SETUP/zen/user.js ]] && cp "$SETUP/zen/user.js" "$prof/user.js"

##############################################################################
# user icon (accountsâ€‘service)
##############################################################################
if [[ -f $SETUP/user-icon ]]; then
  sudo install -D "$SETUP/user-icon" "/var/lib/AccountsService/icons/$USER"
  printf '[User]\nIcon=/var/lib/AccountsService/icons/%s\n' "$USER" | \
    sudo tee "/var/lib/AccountsService/users/$USER" >/dev/null
  sudo systemctl restart accounts-daemon
fi

##############################################################################
# package install
##############################################################################
install_list(){ file="$1"; [[ -f $file ]] || return
  if command -v yay &>/dev/null;  then xargs -a "$file" yay  -S --needed --noconfirm
  elif command -v paru &>/dev/null; then xargs -a "$file" paru -S --needed --noconfirm
  else log "âš ï¸  yay/paru missing â†’ skip packages"; fi
}
install_list "$SETUP/pkglist-repo.txt"
install_list "$SETUP/pkglist-aur.txt"

##############################################################################
# realtime audio limits
##############################################################################
getent group realtime >/dev/null || sudo groupadd realtime
sudo usermod -aG realtime "$USER"
sudo install -Dm644 <(printf '@realtime - rtprio 95\n@realtime - memlock unlimited\n') \
  /etc/security/limits.d/99-realtime.conf

##############################################################################
# envwrapper
##############################################################################
if [[ -d $SETUP/envwrapper ]]; then
  rsync -aHAXx --delete "$SETUP/envwrapper/" "$HOME/.local/share/envwrapper/"
fi

##############################################################################
# /etc files
##############################################################################
if [[ -f $SETUP/environment ]]; then
  read -rp "overwrite /etc/environment with backup? [y/N] " ans
  [[ $ans =~ ^[Yy]$ ]] && sudo cp "$SETUP/environment" /etc/environment
fi
sudo rsync -aHAXx "$SETUP/etc/greetd/" /etc/greetd/

##############################################################################
# .desktop overrides
##############################################################################
if [[ -d $SETUP/desktops ]]; then
  mkdir -p "$HOME/.local/share/applications"
  shopt -s nullglob; cp "$SETUP/desktops"/*.desktop "$HOME/.local/share/applications/"; shopt -u nullglob
fi

##############################################################################
# gtk + cursor theme
##############################################################################
GTK_THEME="catppuccin-latte-pink-standard+default"
ICON_THEME="Colloid-Pink-Catppuccin"
SYS_FONT="GeistMono Nerd Font Mono 11"
CURSOR_THEME="catppuccin-latte-light-cursors"
CURSOR_SIZE=24

mkdir -p "$HOME/.config/gtk-3.0" "$HOME/.config/gtk-4.0"
cat >"$HOME/.config/gtk-3.0/settings.ini"<<EOF
[Settings]
gtk-theme-name=$GTK_THEME
gtk-icon-theme-name=$ICON_THEME
gtk-font-name=$SYS_FONT
EOF
cp "$HOME/.config/gtk-3.0/settings.ini" "$HOME/.config/gtk-4.0/settings.ini"

if command -v gsettings &>/dev/null; then
  gsettings set org.gnome.desktop.interface gtk-theme   "$GTK_THEME"   || true
  gsettings set org.gnome.desktop.interface icon-theme  "$ICON_THEME"  || true
  gsettings set org.gnome.desktop.interface font-name   "$SYS_FONT"    || true
  gsettings set org.gnome.desktop.interface cursor-theme "$CURSOR_THEME"|| true
  gsettings set org.gnome.desktop.interface cursor-size "$CURSOR_SIZE" || true
fi

##############################################################################
# import env + done
##############################################################################
systemctl --user import-environment PATH EDITOR TERMINAL BROWSER || true
log "âœ… restore done â€” reboot recommended."
