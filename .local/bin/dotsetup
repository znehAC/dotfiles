#!/usr/bin/env bash
set -euo pipefail

# pastel restore script
# restores wallpapers, fonts, settings in a clean way

SETUP="$HOME/.setup"

timestamp() {
  date '+%Y-%m-%d %H:%M:%S'
}

log() {
  echo "[$(timestamp)] $*"
}

log "üîß starting pastel restore..."

## === restore wallpapers ===
wallpaper_src="$SETUP/wallpapers/wallpaper.jpg"
wallpaper_dst="$HOME/Pictures/wallpaper.jpg"

if [ -f "$wallpaper_src" ]; then
  log "üñº restoring wallpaper..."
  mkdir -p "$(dirname "$wallpaper_dst")"
  cp "$wallpaper_src" "$wallpaper_dst"
fi

## === restore fonts ===
font_src="$SETUP/fonts"
font_dst="$HOME/.local/share/fonts"

if [ -d "$font_src" ]; then
  log "üî§ restoring fonts..."
  mkdir -p "$font_dst"
  rsync -a --delete "$font_src/" "$font_dst/"
  fc-cache -f
fi

## === restore firefox.desktop ===
firefox_src="$SETUP/firefox/firefox.desktop"
firefox_dst="$HOME/.local/share/applications/firefox.desktop"

if [ -f "$firefox_src" ]; then
  log "üñá restoring firefox.desktop..."
  mkdir -p "$(dirname "$firefox_dst")"
  cp "$firefox_src" "$firefox_dst"
fi

## === restore firefox user.js ===
profile_dir=$(find "$HOME/.mozilla/firefox" -type d -name "*.default*" | head -n1)

if [ -n "$profile_dir" ] && [ -f "$SETUP/firefox/user.js" ]; then
  log "ü¶ä restoring firefox user.js..."
  cp "$SETUP/firefox/user.js" "$profile_dir/user.js"
fi

## === restore SDDM theme ===
theme_name="ittu-motion"
theme_src="$SETUP/sddm-theme"
theme_dst="/usr/share/sddm/themes/$theme_name"

if [ -d "$theme_src" ]; then
  log "üé® restoring SDDM theme ($theme_name)..."
  sudo mkdir -p "$theme_dst"
  sudo rsync -a --delete "$theme_src/" "$theme_dst/"
  sudo chown -R root:root "$theme_dst"

  sudo mkdir -p /etc/sddm.conf.d
  echo -e "[Theme]\nCurrent=$theme_name" | sudo tee /etc/sddm.conf.d/20-theme.conf > /dev/null
fi

## === restore SDDM wallpaper ===
if [ -f "$SETUP/wallpapers/wallpaper.jpg" ]; then
  sudo cp "$SETUP/wallpapers/wallpaper.jpg" "$theme_dst/backgrounds/wallpaper.jpg" || true
fi

## === restore user icon ===
icon_file="$SETUP/user-icon"
if [ -f "$icon_file" ]; then
  log "üë§ restoring user icon..."
  sudo mkdir -p /var/lib/AccountsService/icons/
  sudo mkdir -p /var/lib/AccountsService/users/

  sudo cp "$icon_file" "/var/lib/AccountsService/icons/$USER"
  echo -e "[User]\nIcon=/var/lib/AccountsService/icons/$USER" | sudo tee "/var/lib/AccountsService/users/$USER" > /dev/null
fi

## === install packages from pkglist.txt ===
pkglist="$SETUP/pkglist.txt"

if [ -f "$pkglist" ]; then
  if command -v yay &>/dev/null; then
    log "üì¶ installing packages with yay..."
    yay -S --needed --noconfirm $(< "$pkglist") || true
  elif command -v paru &>/dev/null; then
    log "üì¶ installing packages with paru..."
    paru -S --needed --noconfirm $(< "$pkglist") || true
  else
    log "‚ö†Ô∏è  no yay/paru found, skipping package restore."
  fi
fi

## === restore envwrapper configs ===
env_src="$SETUP/envwrapper"
env_dst="$HOME/.local/share/envwrapper"

if [ -d "$env_src" ]; then
  log "üß¨ restoring envwrapper configs..."
  mkdir -p "$env_dst"
  rsync -a --delete "$env_src/" "$env_dst/"
fi

## === restore local .desktop overrides ===
desktop_src="$SETUP/desktops"
desktop_dst="$HOME/.local/share/applications"

if [ -d "$desktop_src" ]; then
  log "üìÅ restoring .desktop files..."
  mkdir -p "$desktop_dst"
  cp "$desktop_src"/*.desktop "$desktop_dst/" || true
fi

log "‚ôªÔ∏è reloading user environment..."
systemctl --user import-environment PATH EDITOR TERMINAL BROWSER || true

## === apply GTK settings ===
GTK_THEME="catppuccin-latte-pink-standard+default"
ICON_THEME="Colloid-Pink-Catppuccin"
SYSTEM_FONT="GeistMono Nerd Font Mono 11"

log "üé® applying GTK settings..."
mkdir -p "$HOME/.config/gtk-3.0" "$HOME/.config/gtk-4.0"

cat > "$HOME/.config/gtk-3.0/settings.ini" <<EOF
[Settings]
gtk-theme-name=$GTK_THEME
gtk-icon-theme-name=$ICON_THEME
gtk-font-name=$SYSTEM_FONT
EOF

cp "$HOME/.config/gtk-3.0/settings.ini" "$HOME/.config/gtk-4.0/settings.ini"

if pgrep -x dconf-service >/dev/null 2>&1; then
  log "‚öôÔ∏è applying appearance via gsettings..."
  gsettings set org.gnome.desktop.interface gtk-theme "$GTK_THEME" || true
  gsettings set org.gnome.desktop.interface icon-theme "$ICON_THEME" || true
  gsettings set org.gnome.desktop.interface font-name "$SYSTEM_FONT" || true
fi

## === apply cursor settings ===
CURSOR_THEME="catppuccin-latte-light-cursors"
CURSOR_SIZE=24

log "üñ± applying cursor theme..."
gsettings set org.gnome.desktop.interface cursor-theme "$CURSOR_THEME" || true
gsettings set org.gnome.desktop.interface cursor-size "$CURSOR_SIZE" || true

log "‚úÖ restore complete!"
