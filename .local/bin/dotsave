#!/usr/bin/env bash
set -euo pipefail
trap 'echo "[💥] abort at ${BASH_SOURCE[0]}:$LINENO"; exit 1' ERR

##############################################################################
# dot‑save  ─ snapshot wallpapers / fonts / system bits and commit dotfiles  #
##############################################################################

SETUP="$HOME/.setup"
DOT="git --git-dir=$HOME/.dotfiles --work-tree=$HOME"
HOST=$(hostname 2>/dev/null || uname -n)

log() { printf '[%s] %s\n' "$(date '+%F %T')" "$*"; }

log "🧷 saving…"
mkdir -p "$SETUP"

# ─────────────────────────── wallpapers ────────────────────────────────────
for ext in jpg png; do
  wp="$HOME/Pictures/wallpaper.$ext"
  if [[ -f $wp ]]; then
    mkdir -p "$SETUP/wallpapers"
    rsync -aHAXx "$wp" "$SETUP/wallpapers/"
    break
  fi
done

# ───────────────────────────── fonts ───────────────────────────────────────
if [[ -d $HOME/.local/share/fonts ]]; then
  log "🔤 fonts…"
  rsync -aHAXx --delete "$HOME/.local/share/fonts/" "$SETUP/fonts/"
fi

# ─────────────────────────── user icon ─────────────────────────────────────
ICON_SRC="/var/lib/AccountsService/icons/$USER"
[[ -f $ICON_SRC ]] && cp "$ICON_SRC" "$SETUP/user-icon"

# ───────────── zen browser desktop + profile prefs (user.js) ───────────────
if [[ -f /usr/share/applications/zen.desktop ]]; then
  mkdir -p "$SETUP/zen"
  cp /usr/share/applications/zen.desktop "$SETUP/zen/"
fi

profile_dir=$(find "$HOME/.mozilla" -maxdepth 2 -type d -name '*.zen*' | head -n1 || true)
[[ -n $profile_dir && -f $profile_dir/user.js ]] && cp "$profile_dir/user.js" "$SETUP/zen/"

# ──────────────────────────── package lists ────────────────────────────────
if command -v yay &>/dev/null; then
  yay  -Qqen > "$SETUP/pkglist-repo.txt"
  yay  -Qqem > "$SETUP/pkglist-aur.txt"
elif command -v paru &>/dev/null; then
  paru -Qqen > "$SETUP/pkglist-repo.txt"
  paru -Qqem > "$SETUP/pkglist-aur.txt"
fi

# ───────────────────────────── system files ────────────────────────────────
sudo rsync -aHAXx /etc/greetd/ "$SETUP/etc/greetd/"
sudo cp /etc/environment "$SETUP/environment" && sudo chown "$USER":"$USER" "$SETUP/environment"

# ─────────────────────────── dotfiles staging ──────────────────────────────
FILES_TO_TRACK=(
  .zshrc .zshenv .zprofile .gitconfig
  .config/hypr/ .config/waybar/ .config/rofi/
  .config/swaync/ .config/fastfetch/ .config/zsh/
  .config/environment.d/ .config/eww/
  .config/gtk-3.0/ .config/gtk-4.0/
  .config/nvim/ .config/wezterm/ .config/starship.toml
  .setup/ .local/bin/ .local/share/envwrapper/
  .local/share/applications/*.desktop
  .tmux.conf
)

log "📝 staging dotfiles…"
for path in "${FILES_TO_TRACK[@]}"; do
  [[ -e $HOME/$path ]] && $DOT add -- "$path"
done

# ───────────────────── show what will be committed ─────────────────────────
if ! $DOT diff --cached --quiet; then
  log "🔍 changes to commit:"
  printf '%s\n' \
    "────────────────────────────────────────" \
    "$( $DOT diff --cached --name-status | sort )" \
    "────────────────────────────────────────"
else
  log "⚠️  nothing new to commit."
fi

# ───────────────────────────── commit / push ───────────────────────────────
if ! $DOT diff --cached --quiet; then
  log "✅ committing…"
  $DOT commit -m "backup: $(date '+%F %T') on $HOST" >/dev/null
  if [[ ${1:-} == "--push" ]]; then
    log "📡 pushing…"
    $DOT push --quiet
  else
    log "☑️  run 'dot push' later to sync."
  fi
fi
