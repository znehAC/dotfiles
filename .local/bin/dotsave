#!/usr/bin/env bash
set -euo pipefail
trap 'echo "[üí•] abort at ${BASH_SOURCE[0]}:$LINENO"; exit 1' ERR

SETUP="$HOME/.setup"
DOT="git --git-dir=$HOME/.dotfiles --work-tree=$HOME"

log() { printf '[%s] %s\n' "$(date '+%F %T')" "$*"; }

log "üß∑ saving‚Ä¶"
mkdir -p "$SETUP"

# wallpapers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
for ext in jpg png; do
  if [[ -f "$HOME/Pictures/wallpaper.$ext" ]]; then
    mkdir -p "$SETUP/wallpapers"
    rsync -aHAXx "$HOME/Pictures/wallpaper.$ext" "$SETUP/wallpapers/"
    break
  fi
done

# fonts
if [[ -d "$HOME/.local/share/fonts" ]]; then
  log "üî§ fonts‚Ä¶"
  rsync -aHAXx --delete "$HOME/.local/share/fonts/" "$SETUP/fonts/"
fi

# user icon
ICON_SRC="/var/lib/AccountsService/icons/$USER"
[[ -f $ICON_SRC ]] && cp "$ICON_SRC" "$SETUP/user-icon"

# zen browser desktop + user.js
if [[ -f /usr/share/applications/zen.desktop ]]; then
  mkdir -p "$SETUP/zen"
  cp /usr/share/applications/zen.desktop "$SETUP/zen/"
fi

profile_dir=$(find "$HOME/.mozilla" -maxdepth 2 -type d -name '*.zen*' | head -n1 || true)
[[ -n $profile_dir && -f $profile_dir/user.js ]] && cp "$profile_dir/user.js" "$SETUP/zen/"

# pkg lists
if command -v yay &>/dev/null; then
  yay -Qqen > "$SETUP/pkglist-repo.txt"
  yay -Qqem > "$SETUP/pkglist-aur.txt"
elif command -v paru &>/dev/null; then
  paru -Qqen > "$SETUP/pkglist-repo.txt"
  paru -Qqem > "$SETUP/pkglist-aur.txt"
fi

# greetd + environment
sudo rsync -aHAXx /etc/greetd/ "$SETUP/etc/greetd/"
sudo cp /etc/environment "$SETUP/environment"
sudo chown "$USER":"$USER" "$SETUP/environment"

# dotfiles tracking list
FILES_TO_TRACK=(
  .zshrc .zshenv .zprofile .gitconfig
  .config/hypr/ .config/waybar/ .config/rofi/
  .config/swaync/ .config/fastfetch/ .config/zsh/
  .config/environment.d/ .config/eww/
  .config/gtk-3.0/ .config/gtk-4.0/
  .config/nvim/ .config/wezterm/ .config/starship.toml
  .setup/ .local/bin/ .local/share/envwrapper/
  .local/share/applications/*.desktop
  .tmux.conf
)

log "üìù staging‚Ä¶"
for f in "${FILES_TO_TRACK[@]}"; do
  [[ -e $HOME/$f ]] && $DOT add -- "$f"
done

if ! $DOT diff --cached --quiet; then
  log "‚úÖ committing‚Ä¶"
  $DOT commit -m "backup: $(date '+%F %T') on $(hostname)"
  [[ ${1:-} == "--push" ]] && $DOT push
else
  log "‚ö†Ô∏è  nothing to commit."
fi
