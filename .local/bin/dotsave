#!/usr/bin/env bash
set -euo pipefail
trap 'echo "[ğŸ’¥] abort at ${BASH_SOURCE[0]}:$LINENO"; exit 1' ERR

##############################################################################
# dotâ€‘save  â”€ snapshot wallpapers / fonts / system bits and commit dotfiles  #
##############################################################################

SETUP="$HOME/.setup"
DOT="git --git-dir=$HOME/.dotfiles --work-tree=$HOME"
HOST=$(hostname 2>/dev/null || uname -n)

log() { printf '[%s] %s\n' "$(date '+%F %T')" "$*"; }

log "ğŸ§· savingâ€¦"
mkdir -p "$SETUP"

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ wallpapers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
for ext in jpg png; do
  wp="$HOME/Pictures/wallpaper.$ext"
  if [[ -f $wp ]]; then
    mkdir -p "$SETUP/wallpapers"
    rsync -aHAXx "$wp" "$SETUP/wallpapers/"
    break
  fi
done

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ fonts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if [[ -d $HOME/.local/share/fonts ]]; then
  log "ğŸ”¤ fontsâ€¦"
  rsync -aHAXx --delete "$HOME/.local/share/fonts/" "$SETUP/fonts/"
fi

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ user icon â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ICON_SRC="/var/lib/AccountsService/icons/$USER"
[[ -f $ICON_SRC ]] && cp "$ICON_SRC" "$SETUP/user-icon"

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ zen browser desktop + profile prefs (user.js) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if [[ -f /usr/share/applications/zen.desktop ]]; then
  mkdir -p "$SETUP/zen"
  cp /usr/share/applications/zen.desktop "$SETUP/zen/"
fi

profile_dir=$(find "$HOME/.mozilla" -maxdepth 2 -type d -name '*.zen*' | head -n1 || true)
[[ -n $profile_dir && -f $profile_dir/user.js ]] && cp "$profile_dir/user.js" "$SETUP/zen/"

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ package lists â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if command -v yay &>/dev/null; then
  yay  -Qqen > "$SETUP/pkglist-repo.txt"
  yay  -Qqem > "$SETUP/pkglist-aur.txt"
elif command -v paru &>/dev/null; then
  paru -Qqen > "$SETUP/pkglist-repo.txt"
  paru -Qqem > "$SETUP/pkglist-aur.txt"
fi

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ system files â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
sudo rsync -aHAXx /etc/greetd/ "$SETUP/etc/greetd/"
sudo cp /etc/environment "$SETUP/environment" && sudo chown "$USER":"$USER" "$SETUP/environment"

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ dotfiles staging â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
FILES_TO_TRACK=(
  .zshrc .zshenv .zprofile .gitconfig
  .config/hypr/ .config/waybar/ .config/rofi/
  .config/swaync/ .config/fastfetch/ .config/zsh/
  .config/environment.d/ .config/eww/
  .config/gtk-3.0/ .config/gtk-4.0/
  .config/nvim/ .config/wezterm/ .config/starship.toml
  .setup/ .local/bin/ .local/share/envwrapper/
  .local/share/applications/*.desktop
  .tmux.conf
)

log "ğŸ“ staging dotfilesâ€¦"
for path in "${FILES_TO_TRACK[@]}"; do
  [[ -e $HOME/$path ]] && $DOT add -- "$path"
done

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ show what will be committed â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if ! $DOT diff --cached --quiet; then
  log "ğŸ” changes to commit:"
  printf '%s\n' \
    "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€" \
    "$( $DOT diff --cached --name-status | sort )" \
    "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
else
  log "âš ï¸  nothing new to commit."
fi

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ commit / push â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if ! $DOT diff --cached --quiet; then
  log "âœ… committingâ€¦"
  $DOT commit -m "backup: $(date '+%F %T') on $HOST" >/dev/null
  if [[ ${1:-} == "--push" ]]; then
    log "ğŸ“¡ pushingâ€¦"
    $DOT push --quiet
  else
    log "â˜‘ï¸  run 'dot push' later to sync."
  fi
fi
